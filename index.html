<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador de Logros de Minecraft</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
</head>
<body>

    <h1>Generador de Logros</h1>

    <div class="container">
        <div class="input-group">
            <label for="topText">Texto Superior (Amarillo)</label>
            <input type="text" id="topText" value="¡Logro obtenido!">
        </div>

        <div class="input-group">
            <label for="bottomText">Texto Inferior (Blanco)</label>
            <input type="text" id="bottomText" value="Madera Nueva">
        </div>

        <div class="input-group">
            <label for="iconSearch">Ícono</label>
            <div class="search-container">
                <input type="text" id="iconSearch" placeholder="Buscar ícono (ej. Golden Apple)..." autocomplete="off" value="Grass Block">
                <div id="searchResults" class="search-results"></div>
            </div>
        </div>

        <div class="preview-area">
            <!-- Canvas visible directly -->
            <canvas id="canvas" width="320" height="64" style="display: block; max-width: 100%; height: auto; image-rendering: pixelated;"></canvas>
        </div>
        <!-- Change font to Minecraftia -->
        <button type="button" onclick="window.downloadImage()">Descargar Logro</button>

        
        
         
        
    </div>

    <script type="module">
        import { items } from './src/items.js';

        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const topTextInput = document.getElementById('topText');
        const bottomTextInput = document.getElementById('bottomText');
        const iconInput = document.getElementById('iconSearch');
        const resultsDiv = document.getElementById('searchResults');

        // Estado
        let currentIconId = 'grass_block'; // Default
        const fontName = 'Minecraftia'; 
        
        // Cargar recursos estáticos
        const bgImage = new Image();
        bgImage.src = 'assets/Logro3.png';
        bgImage.onload = () => draw();
        bgImage.onerror = () => console.warn("Fondo no encontrado, usando fallback.");

        const iconImage = new Image();
        iconImage.crossOrigin = "Anonymous";
        iconImage.onload = () => draw();

        // Inicializar icono por defecto
        updateIconImage(currentIconId);

        // --- Lógica de Formato y Búsqueda ---

        function formatName(id) {
            return id.split('_')
                .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                .join(' ');
        }

        function filterItems(query) {
            const lowerQuery = query.toLowerCase();
            return items.filter(id => {
                const name = formatName(id);
                return name.toLowerCase().includes(lowerQuery) || id.includes(lowerQuery);
            }).slice(0, 10); // Limit results
        }

        function selectItem(id) {
            currentIconId = id;
            iconInput.value = formatName(id);
            resultsDiv.classList.remove('visible');
            updateIconImage(id);
        }

        function updateIconImage(id) {
            // URL del sprite oficial
            const url = `https://assets.mcasset.cloud/1.20.1/assets/minecraft/textures/item/${id}.png`;
            iconImage.src = url;
            // Si falla (ej. es un bloque y la URL es diferente, o no existe), podríamos intentar fallback
            // Por simplicidad en este paso, asumimos items.js tiene items válidos.
        }

        // --- Event Listeners Búsqueda ---

        iconInput.addEventListener('input', (e) => {
            const query = e.target.value;
            if (query.length < 2) {
                resultsDiv.classList.remove('visible');
                return;
            }

            const matches = filterItems(query);
            if (matches.length > 0) {
                resultsDiv.innerHTML = matches.map(id => {
                    const name = formatName(id);
                    const imgUrl = `https://assets.mcasset.cloud/1.20.1/assets/minecraft/textures/item/${id}.png`;
                    return `
                        <div class="search-item" data-id="${id}">
                            <img src="${imgUrl}" alt="${id}" loading="lazy">
                            <span>${name}</span>
                        </div>
                    `;
                }).join('');
                resultsDiv.classList.add('visible');
            } else {
                resultsDiv.classList.remove('visible');
            }
        });

        // Click en resultados
        resultsDiv.addEventListener('click', (e) => {
            const itemDiv = e.target.closest('.search-item');
            if (itemDiv) {
                selectItem(itemDiv.dataset.id);
            }
        });

        // Cerrar al hacer click fuera
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.search-container')) {
                resultsDiv.classList.remove('visible');
            }
        });

        // --- Dibujado ---

        function draw() {
            const width = 320;
            const height = 64;
            
            // Reset canvas
            canvas.width = width;
            canvas.height = height;
            ctx.clearRect(0, 0, width, height);

            // 1. Dibujar Fondo
            if (bgImage.complete && bgImage.naturalWidth > 0) {
                ctx.drawImage(bgImage, 0, 0, width, height);
            } else {
                ctx.fillStyle = '#212121';
                ctx.fillRect(0, 0, width, height);
                ctx.strokeStyle = '#ffffff';
                ctx.lineWidth = 2;
                ctx.strokeRect(0, 0, width, height);
                ctx.fillStyle = '#333333';
                ctx.fillRect(2, 2, width-4, height-4);
            }

            // 2. Dibujar Icono
            const iconSize = 32; 
            const iconX = 16;
            const iconY = (height - iconSize) / 2;
            
            if (iconImage.complete && iconImage.naturalWidth > 0) {
                ctx.imageSmoothingEnabled = false; // Pixel art look
                ctx.drawImage(iconImage, iconX, iconY, iconSize, iconSize);
            }

            // 3. Dibujar Texto
            const textX = 60;
            ctx.font = `12px "${fontName}", "Press Start 2P", monospace`;
            ctx.textBaseline = 'top';
            
            // Top Text (Yellow)
            ctx.fillStyle = '#FFFF55';
            ctx.shadowColor = "#000000"; // Sombra simple para legibilidad si el fondo es claro
            ctx.shadowOffsetX = 2;
            ctx.shadowOffsetY = 2;
            ctx.fillText(topTextInput.value, textX, 14);

            // Bottom Text (White)
            ctx.fillStyle = '#FFFFFF';
            ctx.fillText(bottomTextInput.value, textX, 36);
            
            // Reset shadow
            ctx.shadowColor = "transparent";
        }

        // Exportar función globalmente para el botón onclick del HTML
        window.downloadImage = function() {
            try {
                const link = document.createElement('a');
                link.download = 'logro-minecraft.png';
                link.href = canvas.toDataURL();
                link.click();
            } catch (e) {
                alert("Error al descargar. Intente usar un servidor local (npm run dev).");
                console.error(e);
            }
        };

        // Listeners de texto
        topTextInput.addEventListener('input', draw);
        bottomTextInput.addEventListener('input', draw);
        
        // Esperar fuentes
        document.fonts.ready.then(draw);

    </script>
</body>
</html>
