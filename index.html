<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Achievement Generator</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
</head>
<body>

    <button id="themeToggle" class="theme-toggle" title="Cambiar tema">üåô</button>

    <h1>Achievement Generator</h1>

    <div class="app-layout">
        
        <!-- Panel Izquierdo: Configuraci√≥n -->
        <div class="panel config-panel">
            
            <div class="input-group">
                <label for="bgSelect">Achievement Style</label>
                <select id="bgSelect">
                    <option value="assets/Logro3.png" selected>Style 1</option>
                    <option value="assets/Logro2.png">Style 2</option>
                    <option value="assets/Enchantment.png">Style 3</option>
                    <option value="assets/LogroCompletado.png">Style 4</option>
                </select>
            </div>

            <div class="input-group">
                <label for="iconSizeInput">Icon Size: <span id="iconSizeValue">100</span>px</label>
                <input type="range" id="iconSizeInput" min="32" max="200" value="100" style="width: 100%;">
            </div>

            <div class="input-group">
                <label for="topText">Upper Text</label>
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 5px;">
                    <label for="topFontSizeInput" style="font-size: 0.8rem; margin: 0;">Size:</label>
                    <input type="number" id="topFontSizeInput" value="40" min="10" max="100" style="width: 60px; padding: 5px;">
                </div>
                <div class="text-controls">
                    <input type="text" id="topText" value="Achievement Get!">
                    <select id="topColorSelect" title="Minecraft Color"></select>
                    <input type="color" id="topColorPicker" value="#FFFF55" title="Custom Color">
                </div>
            </div>

            <div class="input-group">
                <label for="bottomText">Bottom Text</label>
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 5px;">
                    <label for="bottomFontSizeInput" style="font-size: 0.8rem; margin: 0;">Size:</label>
                    <input type="number" id="bottomFontSizeInput" value="40" min="10" max="100" style="width: 60px; padding: 5px;">
                </div>
                <div class="text-controls">
                    <input type="text" id="bottomText" value="Getting grass?...">
                    <select id="bottomColorSelect" title="Minecraft Color"></select>
                    <input type="color" id="bottomColorPicker" value="#FFFFFF" title="Custom Color">
                </div>
            </div>

            <div class="preview-area">
                <canvas id="canvas" width="1000" height="221" style="display: block; max-width: 100%; height: auto; image-rendering: pixelated;"></canvas>
            </div>

            <button onclick="window.downloadImage()">Download PNG</button>
        </div>

        <!-- Right Panel: Icon Selector -->
        <div class="panel icon-panel">
            <h3>Select Icon</h3>
            <input type="text" id="iconGridSearch" class="icon-search-bar" placeholder="Search icon..." autocomplete="off">
            
            <div id="iconGrid" class="icon-grid">
                <!-- Filled with JS -->
            </div>

            <div class="custom-upload-group">
                <label for="customIconInput">Upload Custom Texture:</label>
                <div class="file-input-wrapper">
                    <input type="file" id="customIconInput" accept="image/*">
                </div>
            </div>
        </div>

    </div>

    <footer>
        <div class="footer-links">
            <p>Made with ‚ù§Ô∏è by: <a href="https://github.com/brnomt" target="_blank">brnomt</a> & <a href="https://github.com/iamnotSnoker" target="_blank">Snoker</a></p>
        </div>
        <a href="https://github.com/brnomt/AdvancementGenerator" target="_blank" class="github-link">View source on GitHub</a>
        <div class="donate-container">
            <a href="https://www.paypal.com/donate/?hosted_button_id=GWVA5XBU7V3GL" class="donate-btn">‚òï Buy me a coffee!</a>
        </div>
    </footer>

    <script type="module">
        import { items } from './src/items.js';

        // Elementos DOM
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const topTextInput = document.getElementById('topText');
        const bottomTextInput = document.getElementById('bottomText');
        
        // New Selectors
        const bgSelect = document.getElementById('bgSelect');
        const topFontSizeInput = document.getElementById('topFontSizeInput');
        const bottomFontSizeInput = document.getElementById('bottomFontSizeInput');
        const iconSizeInput = document.getElementById('iconSizeInput');
        const iconSizeValue = document.getElementById('iconSizeValue');

        const iconGrid = document.getElementById('iconGrid');
        const iconSearch = document.getElementById('iconGridSearch');
        const customIconInput = document.getElementById('customIconInput');

        // Color Controls
        const topColorSelect = document.getElementById('topColorSelect');
        const topColorPicker = document.getElementById('topColorPicker');
        const bottomColorSelect = document.getElementById('bottomColorSelect');
        const bottomColorPicker = document.getElementById('bottomColorPicker');

        // Estado
        // Buscamos un icono inicial v√°lido (Grass_Block o el primero de la lista)
        const initialItem = items.find(i => i.id === 'Grass_Block') || items[0];
        let currentIconData = initialItem;
        
        // Colores Minecraft
        const mcColors = {
            'yellow': { name: 'Yellow', hex: '#FFFF55' },
            'white': { name: 'White', hex: '#FFFFFF' },
            'gold': { name: 'Gold', hex: '#FFAA00' },
            'green': { name: 'Green', hex: '#55FF55' },
            'dark_green': { name: 'Dark Green', hex: '#00AA00' },
            'red': { name: 'Red', hex: '#FF5555' },
            'dark_red': { name: 'Dark Red', hex: '#AA0000' },
            'aqua': { name: 'Aqua', hex: '#55FFFF' },
            'dark_aqua': { name: 'Dark Aqua', hex: '#00AAAA' },
            'blue': { name: 'Blue', hex: '#5555FF' },
            'dark_blue': { name: 'Dark Blue', hex: '#0000AA' },
            'light_purple': { name: 'Light Purple', hex: '#FF55FF' },
            'dark_purple': { name: 'Dark Purple', hex: '#AA00AA' },
            'gray': { name: 'Gray', hex: '#AAAAAA' },
            'dark_gray': { name: 'Dark Gray', hex: '#555555' },
            'black': { name: 'Black', hex: '#000000' }
        };

        // Cargar Im√°genes Globales
        const bgImage = new Image();
        bgImage.src = bgSelect.value;
        bgImage.onload = () => draw();
        bgImage.onerror = () => console.warn("Fondo no encontrado.");

        const iconImage = new Image();
        iconImage.onload = () => draw();

        // --- Inicializaci√≥n ---

        function setupColorControl(select, picker, defaultKey) {
            for (const [key, val] of Object.entries(mcColors)) {
                const option = document.createElement('option');
                option.value = val.hex;
                option.textContent = val.name;
                if (key === defaultKey) option.selected = true;
                select.appendChild(option);
            }


            if (mcColors[defaultKey]) picker.value = mcColors[defaultKey].hex;

            select.addEventListener('change', () => {
                if (select.value !== 'custom') picker.value = select.value;
                draw();
            });
            picker.addEventListener('input', () => {
                select.value = 'custom';
                draw();
            });
        }

        setupColorControl(topColorSelect, topColorPicker, 'yellow');
        setupColorControl(bottomColorSelect, bottomColorPicker, 'white');


        // --- L√≥gica del Grid de Iconos ---

        function formatName(id) {
            // El ID ya viene con may√∫sculas de los archivos
            return id.replace(/_/g, ' ');
        }

        function renderGrid(filter = "") {
            iconGrid.innerHTML = '';
            const lowerFilter = filter.toLowerCase();
            
            // Filtrar items
            const filteredItems = items.filter(item => {
                return item.id.toLowerCase().includes(lowerFilter) || formatName(item.id).toLowerCase().includes(lowerFilter);
            }).slice(0, 500); // Limitamos a 500 para rendimiento de renderizado inicial

            // Renderizar items
            filteredItems.forEach(item => {
                const slot = document.createElement('div');
                slot.className = `icon-slot ${item.id === currentIconData?.id ? 'selected' : ''}`;
                slot.title = formatName(item.id);
                slot.dataset.id = item.id;
                
                const img = document.createElement('img');
                img.src = `assets/icons2/${item.id}.${item.ext}`;
                img.alt = item.id;
                img.loading = 'lazy';
                
                slot.appendChild(img);
                
                slot.addEventListener('click', () => {
                    selectIcon(item);
                });

                iconGrid.appendChild(slot);
            });
        }

        function selectIcon(item) {
            currentIconData = item;
            // Update visual selection
            document.querySelectorAll('.icon-slot').forEach(el => el.classList.remove('selected'));
            const active = document.querySelector(`.icon-slot[data-id="${item.id}"]`);
            if(active) active.classList.add('selected');
            
            // Load image
            iconImage.src = `assets/icons2/${item.id}.${item.ext}`;
        }

        // B√∫squeda en Grid
        iconSearch.addEventListener('input', (e) => {
            renderGrid(e.target.value);
        });

        // Carga Custom Icon
        customIconInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (evt) => {
                    iconImage.src = evt.target.result;
                    document.querySelectorAll('.icon-slot').forEach(el => el.classList.remove('selected'));
                    currentIconData = { id: 'custom' };
                };
                reader.readAsDataURL(file);
            }
        });

        // --- Dibujado ---
        function draw() {
            const width = 1000;
            const height = 221;
            canvas.width = width;
            canvas.height = height;
            ctx.clearRect(0, 0, width, height);

            // Fondo
            if (bgImage.complete && bgImage.naturalWidth > 0) {
                ctx.drawImage(bgImage, 0, 0, width, height);
            } else {
                ctx.fillStyle = '#212121';
                ctx.fillRect(0, 0, width, height);
                ctx.strokeStyle = '#ffffff';
                ctx.lineWidth = 2;
                ctx.strokeRect(0, 0, width, height);
                ctx.fillStyle = '#333333';
                ctx.fillRect(2, 2, width-4, height-4);
            }

            // Icono
            const iconSize = parseInt(iconSizeInput.value, 10);
            iconSizeValue.textContent = iconSize;

            const iconX = 50;
            const iconY = (height - iconSize) / 2;
            
            if (iconImage.complete && iconImage.naturalWidth > 0) {
                ctx.imageSmoothingEnabled = false;
                ctx.drawImage(iconImage, iconX, iconY, iconSize, iconSize);
            }

            // Texto
            const textX = iconX + iconSize + 30;
            ctx.textBaseline = 'top';
            
            // Top Text
            const topSize = topFontSizeInput.value;
            ctx.font = `${topSize}px "Minecraftia", "Press Start 2P", monospace`;
            ctx.fillStyle = topColorPicker.value;
            ctx.shadowColor = "#000000"; 
            ctx.shadowOffsetX = 4;
            ctx.shadowOffsetY = 4;
            ctx.fillText(topTextInput.value, textX, 60);

            // Bottom Text
            const bottomSize = bottomFontSizeInput.value;
            ctx.font = `${bottomSize}px "Minecraftia", "Press Start 2P", monospace`;
            ctx.fillStyle = bottomColorPicker.value;
            ctx.fillText(bottomTextInput.value, textX, 120);
            
            ctx.shadowColor = "transparent";
        }

        window.downloadImage = function() {
            try {
                const link = document.createElement('a');
                link.download = `minecraft-advancement_"${topTextInput.value}_${bottomTextInput.value}".png`;
                link.href = canvas.toDataURL();
                link.click();
            } catch (e) {
                alert("Error al descargar. Use un servidor local.");
            }
        };

        // Listeners
        topTextInput.addEventListener('input', draw);
        bottomTextInput.addEventListener('input', draw);
        
        bgSelect.addEventListener('change', () => {
            bgImage.src = bgSelect.value;
            // onload handles draw()
        });
        topFontSizeInput.addEventListener('input', draw);
        bottomFontSizeInput.addEventListener('input', draw);
        iconSizeInput.addEventListener('input', draw);
        
        // Init
        document.fonts.ready.then(draw);
        renderGrid(); 
        if (currentIconData) {
            iconImage.src = `assets/icons2/${currentIconData.id}.${currentIconData.ext}`;
        }

        // --- Theme Toggle Logic ---
        const themeBtn = document.getElementById('themeToggle');
        
        // Load saved theme
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme === 'light') {
            document.body.classList.add('light-mode');
            themeBtn.textContent = '‚òÄÔ∏è';
        }

        themeBtn.addEventListener('click', () => {
            document.body.classList.toggle('light-mode');
            const isLight = document.body.classList.contains('light-mode');
            themeBtn.textContent = isLight ? '‚òÄÔ∏è' : 'üåô';
            localStorage.setItem('theme', isLight ? 'light' : 'dark');
        });

    </script>
</body>
</html>